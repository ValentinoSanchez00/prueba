name: Prueba de ZAP

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'URL a probar'
        required: true

permissions:
  issues: write

jobs:
  zap:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configurar variables
        env:
          ZAP_API_KEY: ${{ secrets.ZAP_API_KEY }}
          SCAN_URL: ${{ github.event.inputs.url }}
        run: |
          echo "Configurando variables..."
          if [ -z "$ZAP_API_KEY" ]; then
            echo "ERROR: ZAP_API_KEY no está configurado."
            exit 1
          fi
          echo "URL configurada para el escaneo: $SCAN_URL"
      
      - name: Logearme Cluster IBM
        env:
            APIKEY: ${{ secrets.IBM_API_KEY }}
        run: |
              echo "Logeándome en el clúster IBM..."
              ls -l
              ibmcloud login --apikey ${APIKEY} -r eu-gb
              ibmcloud target -g Stemdo_Sandbox
              ibmcloud cr region-set global
              ibmcloud cr login
              ibmcloud cr namespace-add cr-vsanchez
              ibmcloud ks cluster config --cluster ez-ibm-openshift-vpc-3zyj --admin

      - name: Ejecutar ZAP Spider
        env:
          ZAP_API_URL: 'https://zap-api-route-test-ctenorio.ez-ibm-openshift-vpc-3zyj-b9be9ed6ae33d743815245d0b773ebc7-0000.eu-es.containers.appdomain.cloud/JSON/spider/action/scan/?url=https://juice-shop.herokuapp.com'
          SCAN_URL: ${{ github.event.inputs.url }}
        run: |
          echo "Iniciando el Spider de ZAP..."
          curl "${ZAP_API_URL}/JSON/spider/action/scan/?url=${SCAN_URL}" -o zap_spider_start.json
          cat zap_spider_start.json

      - name: Monitorizar estado del Spider
        env:
          ZAP_API_URL: 'https://zap-api-route-test-ctenorio.ez-ibm-openshift-vpc-3zyj-b9be9ed6ae33d743815245d0b773ebc7-0000.eu-es.containers.appdomain.cloud/JSON/spider/action/scan/?url=https://juice-shop.herokuapp.com'
        run: |
          echo "Comprobando estado del Spider..."
          until [ "$(curl -s "${ZAP_API_URL}/JSON/spider/view/status/" | grep -o '100')" ]; do
            echo 'El Spider está en ejecución...'; sleep 5;
          done
          echo "El Spider ha finalizado."

      - name: Generar informe HTML
        env:
          ZAP_API_URL: 'https://zap-api-route-test-ctenorio.ez-ibm-openshift-vpc-3zyj-b9be9ed6ae33d743815245d0b773ebc7-0000.eu-es.containers.appdomain.cloud/JSON/spider/action/scan/?url=https://juice-shop.herokuapp.com'
        run: |
          echo "Generando informe en HTML..."
          curl "${ZAP_API_URL}/OTHER/core/other/htmlreport/" -o "zap_report_$(date +'%Y%m%d_%H%M%S').html"

      - name: Subir informe de ZAP
        uses: actions/upload-artifact@v3
        with:
          name: zap-report
          path: zap_report_*.html
